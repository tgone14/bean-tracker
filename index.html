<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bean - Dialysis Tracker</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3594/3594041.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f3f4f6; -webkit-tap-highlight-color: transparent; }
        .bean-gradient { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .progress-bar-bg { background-color: #e5e7eb; border-radius: 9999px; height: 1.2rem; overflow: hidden; }
        .progress-fill { height: 100%; transition: width 0.5s ease-in-out; }
        input, select { font-size: 16px !important; } /* Prevents iOS zoom on focus */
    </style>
</head>
<body class="pb-24">

    <header class="bean-gradient text-white p-6 shadow-lg rounded-b-3xl mb-4 text-center">
        <h1 class="text-3xl font-bold">Bean</h1>
        <p class="text-sm opacity-90" id="current-date"></p>
    </header>

    <main class="max-w-md mx-auto p-4 space-y-6">

        <section class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h2 class="text-lg font-bold text-gray-700">Net Daily Intake</h2>
                <button onclick="exportData()" class="text-xs bg-blue-100 text-blue-600 px-3 py-1 rounded-full font-bold">üìÑ Export Report</button>
            </div>
            
            <div class="mb-4">
                <div class="flex justify-between text-sm mb-1">
                    <span class="font-medium text-gray-600">Potassium (K)</span>
                    <span class="font-bold text-gray-800"><span id="total-k">0</span> / <span id="disp-limit-k">2000</span> mg</span>
                </div>
                <div class="progress-bar-bg">
                    <div id="bar-k" class="progress-fill bg-blue-500" style="width: 0%"></div>
                </div>
            </div>

            <div class="mb-4">
                <div class="flex justify-between text-sm mb-1">
                    <span class="font-medium text-gray-600">Net Phosphorus (P)</span>
                    <span class="font-bold text-gray-800"><span id="total-p">0</span> / <span id="disp-limit-p">1000</span> mg</span>
                </div>
                <div class="progress-bar-bg">
                    <div id="bar-p" class="progress-fill bg-purple-500" style="width: 0%"></div>
                </div>
            </div>

            <div>
                <div class="flex justify-between text-sm mb-1">
                    <span class="font-medium text-gray-600">Fluid</span>
                    <span class="font-bold text-gray-800"><span id="total-f">0</span> / <span id="disp-limit-f">1000</span> ml</span>
                </div>
                <div class="progress-bar-bg">
                    <div id="bar-f" class="progress-fill bg-teal-400" style="width: 0%"></div>
                </div>
            </div>
        </section>

        <div class="flex space-x-1 bg-gray-200 p-1 rounded-xl">
            <button onclick="switchTab('food')" id="tab-food" class="flex-1 py-2 rounded-lg font-bold text-sm bg-white shadow text-gray-800">üçé Food</button>
            <button onclick="switchTab('binder')" id="tab-binder" class="flex-1 py-2 rounded-lg font-bold text-sm text-gray-500">üíä Binder</button>
            <button onclick="switchTab('history')" id="tab-history" class="flex-1 py-2 rounded-lg font-bold text-sm text-gray-500">üìú History</button>
        </div>

        <section id="section-food" class="bg-white p-5 rounded-2xl shadow-sm">
            <div class="space-y-3">
                <select id="category-select" class="w-full p-3 bg-gray-50 border rounded-xl">
                    <option value="" disabled selected>Select Category</option>
                </select>
                <select id="food-select" class="w-full p-3 bg-gray-50 border rounded-xl" disabled>
                    <option value="" disabled selected>Select Item</option>
                </select>
                <button onclick="addFood()" id="add-food-btn" class="w-full bg-gray-800 text-white font-bold py-3 rounded-xl disabled:opacity-50" disabled>Add to Log</button>
            </div>
        </section>

        <section id="section-binder" class="hidden bg-white p-5 rounded-2xl shadow-sm border-l-4 border-green-400">
            <div class="space-y-3">
                <select id="binder-select" class="w-full p-3 bg-gray-50 border rounded-xl">
                    <option value="" disabled selected>Select Binder</option>
                </select>
                <button onclick="addBinder()" id="add-binder-btn" class="w-full bg-green-600 text-white font-bold py-3 rounded-xl disabled:opacity-50" disabled>Take Binder</button>
            </div>
        </section>

        <section id="section-history" class="hidden space-y-3">
            <h2 class="text-gray-600 font-bold px-1">Past 7 Days</h2>
            <div id="history-list" class="space-y-2"></div>
        </section>

        <section id="section-log">
            <div class="flex justify-between items-center mb-3 px-1">
                <h2 class="text-lg font-semibold text-gray-700">Today's Entries</h2>
                <button onclick="clearToday()" class="text-xs text-red-400 font-bold uppercase">Reset Day</button>
            </div>
            <ul id="log-list" class="space-y-2"></ul>
        </section>

        <details class="bg-gray-100 p-4 rounded-xl">
            <summary class="text-sm font-bold text-gray-500 cursor-pointer">‚öôÔ∏è Settings & Limits</summary>
            <div class="grid grid-cols-1 gap-4 mt-3">
                <div class="grid grid-cols-3 gap-2">
                    <div>
                        <label class="block text-[10px] font-bold text-gray-400 uppercase">Potassium (mg)</label>
                        <input type="number" id="limit-k" class="w-full p-2 border rounded-lg text-sm" onchange="saveSettings()">
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-gray-400 uppercase">Phosphorus (mg)</label>
                        <input type="number" id="limit-p" class="w-full p-2 border rounded-lg text-sm" onchange="saveSettings()">
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-gray-400 uppercase">Fluids (mL)</label>
                        <input type="number" id="limit-f" class="w-full p-2 border rounded-lg text-sm" onchange="saveSettings()">
                    </div>
                </div>
            </div>
            <button onclick="if(confirm('This will wipe all your data. Continue?')){localStorage.clear(); location.reload();}" class="w-full mt-4 text-[10px] text-red-400 uppercase tracking-widest font-bold">Reset All Stored Data</button>
        </details>

    </main>

    <script>
        // --- DATA ---
        const foodDatabase = {
            "Fruits": [{ name: "Apple", k: 195, p: 20, f: 0 }, { name: "Banana", k: 422, p: 26, f: 0 }, { name: "Grapes (1c)", k: 288, p: 30, f: 0 }, { name: "Watermelon (1c)", k: 170, p: 15, f: 140 }],
            "Vegetables": [{ name: "Carrots", k: 180, p: 24, f: 0 }, { name: "Potato", k: 926, p: 121, f: 0 }, { name: "Green Beans", k: 90, p: 19, f: 0 }],
            "Proteins": [{ name: "Chicken (3oz)", k: 220, p: 196, f: 0 }, { name: "Egg (1)", k: 69, p: 95, f: 0 }, { name: "Salmon", k: 326, p: 214, f: 0 }],
            "Dairy/Grains": [{ name: "Milk (1c)", k: 366, p: 232, f: 240 }, { name: "Rice (1c)", k: 55, p: 68, f: 0 }, { name: "White Bread", k: 30, p: 30, f: 0 }],
            "Beverages": [{ name: "Water (8oz)", k: 0, p: 0, f: 240 }, { name: "Coffee", k: 116, p: 7, f: 240 }, { name: "Cola", k: 0, p: 40, f: 355 }]
        };
        const binderDatabase = [
            { name: "Calcium Carbonate (500mg)", bind: 19 }, { name: "Calcium Acetate (667mg)", bind: 30 },
            { name: "Sevelamer HCl (800mg)", bind: 17 }, { name: "Lanthanum (500mg)", bind: 45 },
            { name: "Lanthanum (750mg)", bind: 68 }, { name: "Velphoro (500mg)", bind: 130 }
        ];

        // --- STATE ---
        let dailyLog = JSON.parse(localStorage.getItem('bean_log')) || [];
        let limits = JSON.parse(localStorage.getItem('bean_limits')) || { k: 2000, p: 1000, f: 1000 };
        let history = JSON.parse(localStorage.getItem('bean_history')) || {};
        const todayKey = new Date().toISOString().split('T')[0];

        // --- INIT ---
        function init() {
            document.getElementById('current-date').textContent = new Date().toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' });
            Object.keys(foodDatabase).forEach(c => { const o = document.createElement('option'); o.value = c; o.textContent = c; document.getElementById('category-select').appendChild(o); });
            binderDatabase.forEach((b, i) => { const o = document.createElement('option'); o.value = i; o.textContent = b.name; document.getElementById('binder-select').appendChild(o); });
            
            // Sync setting inputs
            document.getElementById('limit-k').value = limits.k; 
            document.getElementById('limit-p').value = limits.p; 
            document.getElementById('limit-f').value = limits.f;
            document.getElementById('disp-limit-k').textContent = limits.k;
            document.getElementById('disp-limit-p').textContent = limits.p;
            document.getElementById('disp-limit-f').textContent = limits.f;

            renderLog(); 
            updateTotals();
        }

        // --- UI LOGIC ---
        function switchTab(t) {
            ['food', 'binder', 'history'].forEach(tab => {
                document.getElementById(`section-${tab}`).classList.toggle('hidden', t !== tab);
                const btn = document.getElementById(`tab-${tab}`);
                if(t === tab) { btn.classList.add('bg-white', 'shadow', 'text-gray-800'); btn.classList.remove('text-gray-500'); }
                else { btn.classList.remove('bg-white', 'shadow', 'text-gray-800'); btn.classList.add('text-gray-500'); }
            });
            document.getElementById('section-log').classList.toggle('hidden', t === 'history');
            if(t === 'history') renderHistory();
        }

        document.getElementById('category-select').onchange = (e) => {
            const fs = document.getElementById('food-select'); fs.innerHTML = '<option disabled selected>Select Item</option>'; fs.disabled = false;
            foodDatabase[e.target.value].forEach((f, i) => { const o = document.createElement('option'); o.value = i; o.textContent = f.name; fs.appendChild(o); });
        };
        document.getElementById('food-select').onchange = () => document.getElementById('add-food-btn').disabled = false;
        document.getElementById('binder-select').onchange = () => document.getElementById('add-binder-btn').disabled = false;

        function addFood() {
            const f = foodDatabase[document.getElementById('category-select').value][document.getElementById('food-select').value];
            dailyLog.push({ ...f, type: 'food', id: Date.now() }); saveAll();
        }

        function addBinder() {
            const b = binderDatabase[document.getElementById('binder-select').value];
            dailyLog.push({ name: b.name, k: 0, p: -b.bind, f: 0, type: 'binder', id: Date.now() }); saveAll();
        }

        function saveAll() {
            localStorage.setItem('bean_log', JSON.stringify(dailyLog));
            let tk=0, tp=0, tf=0; dailyLog.forEach(i => { tk+=i.k; tp+=i.p; tf+=i.f; });
            history[todayKey] = { k: tk, p: Math.max(0, tp), f: tf };
            localStorage.setItem('bean_history', JSON.stringify(history));
            renderLog(); updateTotals();
        }

        function updateTotals() {
            let tk=0, tp=0, tf=0; dailyLog.forEach(i => { tk+=i.k; tp+=i.p; tf+=i.f; });
            const netP = Math.max(0, tp);
            document.getElementById('total-k').textContent = tk;
            document.getElementById('total-p').textContent = netP;
            document.getElementById('total-f').textContent = tf;
            updateBar('bar-k', tk, limits.k); updateBar('bar-p', netP, limits.p); updateBar('bar-f', tf, limits.f);
        }

        function updateBar(id, v, m) {
            const pct = Math.min((v/m)*100, 100); const b = document.getElementById(id); b.style.width = pct+'%';
            b.className = `progress-fill transition-all ${pct >= 100 ? 'bg-red-500' : pct > 80 ? 'bg-yellow-400' : id === 'bar-f' ? 'bg-teal-400' : id === 'bar-k' ? 'bg-blue-500' : 'bg-purple-500'}`;
        }

        function renderLog() {
            const list = document.getElementById('log-list'); list.innerHTML = '';
            if (dailyLog.length === 0) list.innerHTML = '<li class="text-center text-gray-400 py-4 italic text-sm">No entries yet.</li>';
            dailyLog.slice().reverse().forEach(i => {
                const li = document.createElement('li');
                li.className = `p-3 rounded-xl shadow-sm flex justify-between items-center ${i.type === 'binder' ? 'bg-green-50 border border-green-100' : 'bg-white'}`;
                li.innerHTML = `<div><div class="font-bold text-sm">${i.type === 'binder' ? 'üíä '+i.name : i.name}</div>
                    <div class="text-xs text-gray-500">${i.type === 'food' ? `K: ${i.k} P: ${i.p} F: ${i.f}` : `Binds: ${Math.abs(i.p)}mg P`}</div></div>
                    <button onclick="removeItem(${i.id})" class="text-gray-300 px-2">‚úï</button>`;
                list.appendChild(li);
            });
        }

        function renderHistory() {
            const hl = document.getElementById('history-list'); hl.innerHTML = '';
            const dates = Object.keys(history).sort().reverse().slice(0, 7);
            if (dates.length === 0) hl.innerHTML = '<div class="text-center text-gray-400 py-4 italic text-sm">No history recorded yet.</div>';
            dates.forEach(date => {
                const data = history[date];
                const div = document.createElement('div');
                div.className = "bg-white p-3 rounded-xl text-sm border-l-4 border-purple-400";
                div.innerHTML = `<div class="font-bold text-gray-400 mb-1">${date === todayKey ? 'Today' : date}</div>
                    <div class="flex justify-between"><span>K: <b>${data.k}</b></span> <span>P: <b>${data.p}</b></span> <span>F: <b>${data.f}ml</b></span></div>`;
                hl.appendChild(div);
            });
        }

        function exportData() {
            let report = `BEAN DIALYSIS REPORT\nGenerated: ${new Date().toLocaleString()}\n\n`;
            Object.keys(history).sort().reverse().slice(0,7).forEach(d => {
                report += `${d}: K: ${history[d].k}mg, P: ${history[d].p}mg, Fluid: ${history[d].f}ml\n`;
            });
            const mailto = `mailto:?subject=Bean Dialysis Report&body=${encodeURIComponent(report)}`;
            window.location.href = mailto;
        }

        function removeItem(id) { dailyLog = dailyLog.filter(i => i.id !== id); saveAll(); }
        function clearToday() { if(confirm("Clear today's entries?")) { dailyLog = []; saveAll(); } }
        
        function saveSettings() {
            limits = { 
                k: parseInt(document.getElementById('limit-k').value) || 2000, 
                p: parseInt(document.getElementById('limit-p').value) || 1000, 
                f: parseInt(document.getElementById('limit-f').value) || 1000 
            };
            localStorage.setItem('bean_limits', JSON.stringify(limits));
            document.getElementById('disp-limit-k').textContent = limits.k; 
            document.getElementById('disp-limit-p').textContent = limits.p; 
            document.getElementById('disp-limit-f').textContent = limits.f;
            updateTotals();
        }

        init();
    </script>
</body>
</html>

